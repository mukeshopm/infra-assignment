trigger: none

pool:
  vmImage: 'windows-latest'

steps:
# 1️⃣ Checkout Repo
- checkout: self
  displayName: "Checkout Repository"

# 2️⃣ Debug – Folder structure check
- script: |
    echo "=== ROOT DIRECTORY ==="
    dir
    echo "=== DEFAULT FOLDER ==="
    dir Default
  displayName: "Debug Repo Structure"

# 3️⃣ Install Terraform
- task: TerraformInstaller@1
  displayName: "Install Terraform"
  inputs:
    terraformVersion: 'latest'

# 4️⃣ Terraform Init
- task: TerraformTaskV4@4
  displayName: "Terraform Init"
  inputs:
    provider: 'azurerm'
    command: 'init'
    workingDirectory: '$(System.DefaultWorkingDirectory)/Default'
    environmentServiceNameAzureRM: 'projectwali service connection'

# 5️⃣ Terraform Validate
- task: TerraformTaskV4@4
  displayName: "Terraform Validate"
  inputs:
    provider: 'azurerm'
    command: 'validate'
    workingDirectory: '$(System.DefaultWorkingDirectory)/Default'
    environmentServiceNameAzureRM: 'projectwali service connection'

# 6️⃣ Terraform Plan
- task: TerraformTaskV4@4
  displayName: "Terraform Plan"
  inputs:
    provider: 'azurerm'
    command: 'plan'
    workingDirectory: '$(System.DefaultWorkingDirectory)/Default'
    environmentServiceNameAzureRM: 'projectwali service connection'
    commandOptions: '-out=tfplan'

# 7️⃣ Publish Plan as Artifact (Optional but useful)
- task: PublishPipelineArtifact@1
  displayName: "Publish Terraform Plan Artifact"
  inputs:
    targetPath: '$(System.DefaultWorkingDirectory)/Default'
    artifact: 'terraform-plan'

# 8️⃣ Terraform Apply (Manual Run Only)
- task: TerraformTaskV4@4
  displayName: "Terraform Apply"
  condition: and(succeeded(), eq(variables['Build.Reason'], 'Manual'))
  inputs:
    provider: 'azurerm'
    command: 'apply'
    workingDirectory: '$(System.DefaultWorkingDirectory)/Default'
    environmentServiceNameAzureRM: 'projectwali service connection'
    commandOptions: '-auto-approve'
